parameter (pair (or :st (unit %Gateway) (or (unit %Sender) (or (unit %Finalize) (or (unit %Refund) (unit %TakeReserve))))) (pair address (pair mumav address)));
storage (pair :storage (option %sta (map address mumav)) (option %gtw (pair :gateway (address %gtw_adr) (pair (mumav %rsv) (mumav %tx_sum)))));
code { DUP ;
       DIP { CDR @storage_slash_1 } ;
       CAR @parameter_slash_2 ;
       DUP @parameter ;
       CAR ;
       IF_LEFT { DROP ;
                 { DIP { DUP @storage } ; SWAP } ;
                 CDR %gtw ;
                 IF_NONE { { DIP { DUP @storage } ; SWAP } ;
                           CAR %sta ;
                           PUSH mumav 0 ;
                           AMOUNT ;
                           PAIR %rsv %tx_sum ;
                           SENDER ;
                           PAIR @k %gtw_adr ;
                           SOME ;
                           SWAP ;
                           PAIR %sta %gtw ;
                           NIL operation ;
                           PAIR }
                         { { DIP { DIP { DUP @storage } ; SWAP } ; SWAP } ;
                           CAR %sta ;
                           { DIP { DUP @gtw } ; SWAP } ;
                           { CDR ; CDR %tx_sum } ;
                           { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ;
                           { DIP { DIP { DIP { DROP } } } } ;
                           { CDR ; CAR %rsv } ;
                           AMOUNT ;
                           ADD ;
                           PAIR %rsv %tx_sum ;
                           SENDER ;
                           PAIR @k %gtw_adr ;
                           SOME ;
                           SWAP ;
                           PAIR %sta %gtw ;
                           NIL operation ;
                           PAIR } }
               { IF_LEFT { DROP ;
                           { DIP { DUP @storage } ; SWAP } ;
                           CDR %gtw ;
                           IF_NONE { PUSH string "Gateway doesnt exist" ;
                                     FAILWITH }
                                   { AMOUNT ;
                                     { DIP { DUP @gtw } ; SWAP } ;
                                     { CDR ; CDR %tx_sum } ;
                                     ADD ;
                                     { DIP { DUP @gtw } ; SWAP } ;
                                     { CDR ; CAR %rsv } ;
                                     COMPARE ;
                                     GE ;
                                     IF { { DIP { DIP { DUP @storage } ; SWAP } ; SWAP } ;
                                          CAR %sta ;
                                          IF_NONE { DUP @gtw ;
                                                    { CDR ; CDR %tx_sum } ;
                                                    AMOUNT ;
                                                    ADD ;
                                                    { DIP { DUP @gtw } ; SWAP } ;
                                                    { CDR ; CAR %rsv } ;
                                                    PAIR %rsv %tx_sum ;
                                                    SENDER ;
                                                    PAIR @g %gtw_adr ;
                                                    SOME ;
                                                    PUSH @map (map address mumav) {} ;
                                                    AMOUNT @amnt ;
                                                    SENDER @addr ;
                                                    DIP { SOME } ;
                                                    UPDATE @map ;
                                                    SOME ;
                                                    PAIR @stg %sta %gtw ;
                                                    NIL operation ;
                                                    PAIR }
                                                  { DUP @sta ;
                                                    SENDER @addr ;
                                                    SENDER ;
                                                    { DIP { DUP @addr } ; SWAP } ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF { { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ;
                                                         { CDR ; CDR %tx_sum } ;
                                                         AMOUNT ;
                                                         ADD ;
                                                         { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                         { CDR ; CAR %rsv } ;
                                                         PAIR %rsv %tx_sum ;
                                                         SENDER ;
                                                         PAIR @g %gtw_adr ;
                                                         SOME ;
                                                         { DIP { DIP { DUP @map } ; SWAP } ; SWAP } ;
                                                         { DIP { DIP { DIP { DUP @map } ; SWAP } ; SWAP } ; SWAP } ;
                                                         { DIP { DIP { DIP { DUP @addr } ; SWAP } ; SWAP } ; SWAP } ;
                                                         GET ;
                                                         IF_NONE { PUSH mumav 0 } {} ;
                                                         RENAME @value ;
                                                         AMOUNT ;
                                                         ADD @k ;
                                                         { DIP { DIP { DIP { DUP @addr } ; SWAP } ; SWAP } ; SWAP } ;
                                                         DIP { SOME } ;
                                                         UPDATE @map ;
                                                         SOME ;
                                                         PAIR @stg %sta %gtw ;
                                                         NIL operation ;
                                                         PAIR }
                                                       { PUSH string "Sender adress doesnt match" ;
                                                         FAILWITH } ;
                                                    DIP { DROP ; DROP ; DROP } } }
                                        { PUSH string " Not enough Gateway reserve" ;
                                          FAILWITH } ;
                                     DIP { DROP } } }
                         { IF_LEFT { DROP ;
                                     { DIP { DUP @storage } ; SWAP } ;
                                     CDR %gtw ;
                                     IF_NONE { PUSH string "Gateway doesnt exists " ;
                                               FAILWITH }
                                             { { DIP { DIP { DUP @storage } ; SWAP } ; SWAP } ;
                                               CAR %sta ;
                                               IF_NONE { PUSH string "wait until sender map exists" ;
                                                         FAILWITH }
                                                       { DUP @mp ;
                                                         { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ;
                                                         { CDR ; CAR } ;
                                                         GET ;
                                                         IF_NONE { PUSH string "wait until sender inserts tz" ;
                                                                   FAILWITH }
                                                                 { SENDER @sender ;
                                                                   { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ;
                                                                   CAR %gtw_adr ;
                                                                   COMPARE ;
                                                                   EQ ;
                                                                   IF { { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ;
                                                                        { CDR ; CDR ; CAR } ;
                                                                        { DIP { DUP @l } ; SWAP } ;
                                                                        SUB @k ;
                                                                        PUSH mumav 0 ;
                                                                        { DIP { DUP @k } ; SWAP } ;
                                                                        COMPARE ;
                                                                        EQ ;
                                                                        IF { { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR ; CDR @addr } ;
                                                                             CONTRACT unit ;
                                                                             IF_NONE { PUSH string "invalid contract" ; FAILWITH } {} ;
                                                                             RENAME @dest ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR ; CAR @payout } ;
                                                                             UNIT ;
                                                                             TRANSFER_TOKENS @op ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR ; CAR } ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR %tx_sum } ;
                                                                             SUB ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CAR %rsv } ;
                                                                             PAIR %rsv %tx_sum ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             CAR %gtw_adr ;
                                                                             PAIR @s %gtw_adr ;
                                                                             SOME ;
                                                                             { DIP { DIP { DIP { DIP { DUP @mp } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CAR } ;
                                                                             DIP { NONE mumav } ;
                                                                             UPDATE @new_map ;
                                                                             SOME ;
                                                                             PAIR @str %sta %gtw ;
                                                                             NIL operation ;
                                                                             { DIP { DIP { DUP @op } ; SWAP } ; SWAP } ;
                                                                             { DIP { DIP { DIP { DROP } } } } ;
                                                                             CONS ;
                                                                             PAIR }
                                                                           { { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR ; CDR @addr } ;
                                                                             CONTRACT unit ;
                                                                             IF_NONE { PUSH string "invalid contract" ; FAILWITH } {} ;
                                                                             RENAME @dest ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR ; CAR @payout } ;
                                                                             UNIT ;
                                                                             TRANSFER_TOKENS @op ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR ; CAR } ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CDR %tx_sum } ;
                                                                             SUB ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CAR %rsv } ;
                                                                             PAIR %rsv %tx_sum ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             CAR %gtw_adr ;
                                                                             PAIR @s %gtw_adr ;
                                                                             SOME ;
                                                                             { DIP { DIP { DIP { DIP { DUP @mp } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CAR } ;
                                                                             DIP { NONE mumav } ;
                                                                             UPDATE @new_map ;
                                                                             { DIP { DIP { DIP { DUP @k } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { DIP { DIP { DIP { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             { CDR ; CAR } ;
                                                                             DIP { SOME } ;
                                                                             UPDATE @new_map ;
                                                                             SOME ;
                                                                             PAIR @str %sta %gtw ;
                                                                             NIL operation ;
                                                                             { DIP { DIP { DUP @op } ; SWAP } ; SWAP } ;
                                                                             { DIP { DIP { DIP { DROP } } } } ;
                                                                             CONS ;
                                                                             PAIR } ;
                                                                        DIP { DROP } }
                                                                      { PUSH string "You must be gateway to settle contract" ;
                                                                        FAILWITH } ;
                                                                   DIP { DROP } } ;
                                                         DIP { DROP } } ;
                                               DIP { DROP } } }
                                   { IF_LEFT { DROP ;
                                               { DIP { DUP @storage } ; SWAP } ;
                                               CDR %gtw ;
                                               IF_NONE { PUSH string "Error" ;
                                                         FAILWITH }
                                                       { { DIP { DIP { DUP @storage } ; SWAP } ; SWAP } ;
                                                         CAR %sta ;
                                                         IF_NONE { PUSH string "0 transactions exists" ;
                                                                   FAILWITH }
                                                                 { DUP @mp ;
                                                                   { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ;
                                                                   { CDR ; CAR } ;
                                                                   GET ;
                                                                   IF_NONE { PUSH string "wait until sender inserts tz" ;
                                                                             FAILWITH }
                                                                           { SENDER @sender ;
                                                                             DUP @sender ;
                                                                             { DIP { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                             CAR %gtw_adr ;
                                                                             COMPARE ;
                                                                             NEQ ;
                                                                             IF { PUSH string "fake refund proposal addresses don't match" ;
                                                                                  FAILWITH }
                                                                                { DUP @sender ;
                                                                                  CONTRACT unit ;
                                                                                  IF_NONE { PUSH string "invalid contract" ; FAILWITH } {} ;
                                                                                  RENAME @dest ;
                                                                                  { DIP { DIP { DUP @l } ; SWAP } ; SWAP } ;
                                                                                  UNIT ;
                                                                                  TRANSFER_TOKENS @op ;
                                                                                  { DIP { DIP { DIP { DIP { DIP { DIP { DUP @storage } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                                  CDR %gtw ;
                                                                                  { DIP { DIP { DIP { DIP { DUP @mp } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                                  { DIP { DIP { DIP { DIP { DIP { DIP { DIP { DUP @parameter } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                                                  { CDR ; CAR } ;
                                                                                  DIP { NONE mumav } ;
                                                                                  UPDATE @new_map ;
                                                                                  SOME ;
                                                                                  PAIR %sta %gtw ;
                                                                                  NIL operation ;
                                                                                  { DIP { DIP { DUP @op } ; SWAP } ; SWAP } ;
                                                                                  { DIP { DIP { DIP { DROP } } } } ;
                                                                                  CONS ;
                                                                                  PAIR } ;
                                                                             DIP { DROP ; DROP } } ;
                                                                   DIP { DROP } } ;
                                                         DIP { DROP } } }
                                             { DROP ;
                                               { DIP { DUP @storage } ; SWAP } ;
                                               CDR %gtw ;
                                               IF_NONE { PUSH string "Gateway doesnt exist" ;
                                                         FAILWITH }
                                                       { SENDER ;
                                                         { DIP { DUP @gtw } ; SWAP } ;
                                                         CAR %gtw_adr ;
                                                         COMPARE ;
                                                         EQ ;
                                                         IF { { DIP { DUP @parameter } ; SWAP } ;
                                                              { CDR ; CDR ; CAR @payout } ;
                                                              { DIP { DUP @gtw } ; SWAP } ;
                                                              CAR %gtw_adr ;
                                                              CONTRACT unit ;
                                                              IF_NONE { PUSH string "invalid contract" ; FAILWITH } {} ;
                                                              RENAME @dest ;
                                                              { DIP { DUP @payout } ; SWAP } ;
                                                              UNIT ;
                                                              TRANSFER_TOKENS @op ;
                                                              { DIP { DIP { DIP { DIP { DUP @storage } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                              CAR %sta ;
                                                              { DIP { DIP { DIP { DUP @gtw } ; SWAP } ; SWAP } ; SWAP } ;
                                                              { CDR ; CDR %tx_sum } ;
                                                              { DIP { DIP { DIP { DUP @payout } ; SWAP } ; SWAP } ; SWAP } ;
                                                              { DIP { DIP { DIP { DIP { DROP } } } } } ;
                                                              { DIP { DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ; SWAP } ; SWAP } ;
                                                              { CDR ; CAR %rsv } ;
                                                              SUB ;
                                                              PAIR %rsv %tx_sum ;
                                                              { DIP { DIP { DIP { DUP } ; SWAP } ; SWAP } ; SWAP } ;
                                                              CAR %gtw_adr ;
                                                              PAIR @g %gtw_adr ;
                                                              SOME ;
                                                              SWAP ;
                                                              PAIR %sta %gtw ;
                                                              NIL operation ;
                                                              { DIP { DIP { DUP } ; SWAP } ; SWAP } ;
                                                              { DIP { DIP { DIP { DROP } } } } ;
                                                              CONS ;
                                                              PAIR }
                                                            { PUSH string "You are not gateway" ;
                                                              FAILWITH } ;
                                                         DIP { DROP } } } } } } ;
       DIP { DROP ; DROP } }